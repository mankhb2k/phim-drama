generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum Role {
  USER
  EDITOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum MediaType {
  MOVIE
  TV
}

enum AuthAction {
  LOGIN_SUCCESS
  LOGIN_FAIL
  LOGOUT
}

enum MovieStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  HIDDEN
}

enum VideoStatus {
  OK
  DIE
}

//////////////////////
// USER & AUTH
//////////////////////

model User {
  id            String  @id @default(cuid())
  username      String  @unique
  password      String
  email         String? @unique
  emailVerified Boolean @default(false)

  role   Role       @default(USER)
  status UserStatus @default(ACTIVE)

  sessions  Session[]
  watchlist WatchlistItem[]
  favorites Favorite[]
  viewing   ViewingHistory[]
  authLogs  AuthLog[]

  resetTokens  PasswordResetToken[]
  verifyTokens EmailVerifyToken[]

  movies   Movie[]
  episodes Episode[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model LoginAttempt {
  id        String   @id @default(cuid())
  username  String
  ip        String
  success   Boolean
  createdAt DateTime @default(now())
}

model AuthLog {
  id     String     @id @default(cuid())
  userId String?
  ip     String
  action AuthAction
  time   DateTime   @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model EmailVerifyToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

//////////////////////
// MOVIE FEATURES
//////////////////////

model WatchlistItem {
  id        String    @id @default(cuid())
  userId    String
  tmdbId    Int
  mediaType MediaType
  addedAt   DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tmdbId, mediaType])
}

model Favorite {
  id        String    @id @default(cuid())
  userId    String
  tmdbId    Int
  mediaType MediaType
  addedAt   DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tmdbId, mediaType])
}

model ViewingHistory {
  id        String   @id @default(cuid())
  userId    String
  tmdbId    Int
  progress  Float?
  watchedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, watchedAt])
}

//////////////////////
// EDITOR / MOVIE MVP
//////////////////////

model Movie {
  id          String      @id @default(cuid())
  title       String
  slug        String      @unique
  description String?
  year        Int?
  country     String?
  genres      String[] // MVP: lưu đơn giản
  posterUrl   String?
  status      MovieStatus @default(DRAFT)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  episodes Episode[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdById])
}

model Episode {
  id       String      @id @default(cuid())
  movieId  String
  number   Int
  language String
  status   VideoStatus @default(OK)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  sources EpisodeSource[]

  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([movieId, number, language])
  @@index([movieId])
}

model EpisodeSource {
  id        String      @id @default(cuid())
  episodeId String
  server    String
  url       String
  status    VideoStatus @default(OK)

  episode Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@index([episodeId])
}
